###################################################
### configuration templates (to be used for snapshot and release builds)
variables:
  PDVERSION: 0.50-2
  LANG: C
  # compatibility for older OSX-builds (<mutex> requires C++11, available since OSX10.9/Mavericks)
  MACOSX_DEPLOYMENT_TARGET: "10.9"
  # however, it seems that CI_JOB_NAME is not expanded here!
  ARTIFACTSDIR: artifacts

.build:snapshot: &snapshot
  except:
    - tags
  artifacts:
    name: ${CI_PROJECT_NAME}_${CI_COMMIT_REF_NAME}_${CI_JOB_NAME%_*}
    paths:
      - ${ARTIFACTSDIR}
      - config.log
    when: always

.build:release: &release
  only:
    - tags
  artifacts:
    name: ${CI_PROJECT_NAME}_${CI_COMMIT_REF_NAME}_${CI_JOB_NAME%_*}
    paths:
      - ${ARTIFACTSDIR}

.build:linux: &build_linux
  image: registry.git.iem.at/devtools/docker/debiancross:amd64
  stage: build
  before_script:
    - build/tools/systeminfo.sh || true
    - mkdir -p /etc/apt/sources.list.d/
    - find /etc/apt/sources.list /etc/apt/sources.list.d/ -name "*.list" -type f -exec egrep "^deb " {} ";" | sed -e 's|^deb |deb-src |' > /etc/apt/sources.list.d/${CI_COMMIT_REF_SLUG}.list
    - apt-get update
    - apt-get install -y --no-install-recommends ${TARGETDEBARCH:+-a}${TARGETDEBARCH} puredata-dev puredata-core
    - apt-get build-dep -y --no-install-recommends  ${TARGETDEBARCH:+-a}${TARGETDEBARCH} gem || true
    - apt-get install -y --no-install-recommends  ${TARGETDEBARCH:+-a}${TARGETDEBARCH} libassimp-dev
    - date
    - g++ -v
  script:
    - ./autogen.sh
    - ./configure --disable-dependency-tracking --with-DeckLink=local ${pd_extension:+--with-extension=}${pd_extension} ${TARGETARCH:+--host=}${TARGETARCH}
    - make check -j2
    - make install DESTDIR=$(pwd)/${ARTIFACTSDIR}/${CI_JOB_NAME%_*} libdir=/ extradir=/Gem includedir=/Gem/include
  after_script:
    - mkdir -p "${ARTIFACTSDIR}/${CI_JOB_NAME%_*}"

.build:macos: &build_macos
  tags:
     - bigsur
  retry:
    max: 1
    when:
      - runner_system_failure
  stage: build
  before_script:
    - build/tools/systeminfo.sh || true
    - wget -q -O Pd.tgz http://msp.ucsd.edu/Software/pd-${PDVERSION}.mac.tar.gz
    - rm -rf /Applications/Pd*.app/
    - tar xf Pd.tgz -C /Applications/
    - rm -f Pd.tgz
    - export PD=$(find /Applications/Pd*.app/Contents/Resources/bin/ type f -name pd -print -quit)
    - export PDDIR=$(find /Applications/Pd*.app/Contents/Resources -maxdepth 1 -type d -print -quit)
    - echo "PD=${PD}"
    - echo "PDDIR=${PDDIR}"
    - brew bundle --no-upgrade --file=.git-ci/macOS.brew
    - date
    - g++ -v
  script:
    - /usr/local/opt/gettext/bin/gettextize
    - autoreconf -fiv
    - ./configure --disable-dependency-tracking --enable-fat-binary=x86_64,arm64 --with-pd="${PDDIR}" --with-defaultwindow=gemmacoswindow --with-DeckLink=local ${pd_extension:+--with-extension=}${pd_extension} ${TARGETARCH:+--host=}${TARGETARCH} CXXFLAGS="-std=c++11 -g -O2"
    - make check -j2
    - make install DESTDIR=$(pwd)/${ARTIFACTSDIR}/${CI_JOB_NAME%_*} libdir=/ extradir=/Gem includedir=/Gem/include
  after_script:
    - mkdir -p "${ARTIFACTSDIR}/${CI_JOB_NAME%_*}"
    - find "${ARTIFACTSDIR}/${CI_JOB_NAME%_*}" -type f "(" -name "*.${pd_extension:-d_*}" -o -name "*.pd_darwin" -o -name "*.so" ")" -exec .git-ci/localdeps.macos.sh {} +

.build:w32: &build_w32
  stage: build
  tags:
    - windows
  variables:
    IEMCI_CONFIGURATIONS: mingw32
  before_script:
    - build/tools/systeminfo.sh || true
    - wget -q -O Pd.zip http://msp.ucsd.edu/Software/pd-${PDVERSION}-i386.msw.zip
    - mkdir -p _pd
    - unzip -q Pd.zip -d "_pd"
    - mv -v "_pd"/*/* "_pd"
    - rm -f Pd.zip
    - rm -f _pd/bin/msvcr*.dll
    - export PD="_pd/bin/pd.com"
    - pacman --noconfirm -S --needed $(cat .git-ci/msys2.pacman  | sed -e 's|#.*||' -e "s|@MINGW@|${MINGW_PACKAGE_PREFIX}-|")
    - date
    - g++ -v
  script:
    - autoreconf -fiv || ./autogen.sh
    - ./configure --disable-dependency-tracking --with-pd="$(pwd)/_pd" --with-DeckLink=local CXXFLAGS="-g -O2 -fexceptions" ${pd_extension:+--with-extension=}${pd_extension} ${TARGETARCH:+--host=}${TARGETARCH}
    - make check -j2
    - make install DESTDIR=$(pwd)/${ARTIFACTSDIR}/${CI_JOB_NAME%_*} libdir=/ extradir=/Gem includedir=/Gem/include
  after_script:
    - mkdir -p "${ARTIFACTSDIR}/${CI_JOB_NAME%_*}"
    - find "${ARTIFACTSDIR}/${CI_JOB_NAME%_*}" -type f "(" -name "*.${pd_extension:-m_*}" -o -name "*.dll" -o -name "*.exe" -o -name "*.com" ")" -exec .git-ci/localdeps.win.sh {} +

.build:w64: &build_w64
  stage: build
  tags:
    - windows
  variables:
    IEMCI_CONFIGURATIONS: mingw64
  before_script:
    - build/tools/systeminfo.sh || true
    - wget -q -O Pd.zip http://msp.ucsd.edu/Software/pd-${PDVERSION}.msw.zip
    - mkdir -p _pd
    - unzip -q Pd.zip -d "_pd"
    - mv -v "_pd"/*/* "_pd"
    - rm -f Pd.zip
    - rm -f _pd/bin/msvcr*.dll
    - export PD="_pd/bin/pd.com"
    - pacman --noconfirm -S --needed $(cat .git-ci/msys2.pacman  | sed -e 's|#.*||' -e "s|@MINGW@|${MINGW_PACKAGE_PREFIX}-|")
    - date
    - g++ -v
  script:
    - autoreconf -fiv || ./autogen.sh
    - ./configure --disable-dependency-tracking --with-pd="$(pwd)/_pd" --with-DeckLink=local ${pd_extension:+--with-extension=}${pd_extension} ${TARGETARCH:+--host=}${TARGETARCH}
    - make check -j2
    - make install DESTDIR=$(pwd)/${ARTIFACTSDIR}/${CI_JOB_NAME%_*} libdir=/ extradir=/Gem includedir=/Gem/include
  after_script:
    - mkdir -p "${ARTIFACTSDIR}/${CI_JOB_NAME%_*}"
    - find "${ARTIFACTSDIR}/${CI_JOB_NAME%_*}" -type f "(" -name "*.${pd_extension:-m_*}" -o -name "*.dll" -o -name "*.exe" -o -name "*.com" ")" -exec .git-ci/localdeps.win.sh {} +

###################################################
### the actual jobs: (linux,macos,windows)*(release,snapshot)

Source:
  stage: build
  before_script:
    # we need 'git' to create a source package
    - apt-get update && apt-get --no-install-recommends -y install git
  script:
    # create a source package
    - git archive --format=tar --prefix=${ARTIFACTSDIR}/Source/${CI_PROJECT_NAME}/ HEAD | tar xf -
  artifacts:
    name: ${CI_PROJECT_NAME}_${CI_COMMIT_REF_NAME}_${CI_JOB_NAME%_*}
    paths:
      - ${ARTIFACTSDIR}

Linux:
  <<: *build_linux
  <<: *release
Darwin:
  <<: *build_macos
  <<: *release
W32:
  <<: *build_w32
  <<: *release
W64:
  <<: *build_w64
  <<: *release

Linux_snapshot:
  <<: *build_linux
  <<: *snapshot
Darwin_snapshot:
  <<: *build_macos
  <<: *snapshot
W32_snapshot:
  <<: *build_w32
  <<: *snapshot
W64_snapshot:
  <<: *build_w64
  <<: *snapshot

deken:
  stage: deploy
  image: registry.git.iem.at/pd/deken:latest
  script:
    - chmod -R go-w ${ARTIFACTSDIR}/
# remove ltlib leftovers
    - find ${ARTIFACTSDIR}/ "(" -name "*.la" -or -name "*.a" ")" -delete
# create deken packages
    - for d in ${ARTIFACTSDIR}/*/${CI_PROJECT_NAME}/; do deken package --version="${CI_COMMIT_TAG#v}" "${d}"; done
# upload deken packages
    - test -z "${CI_COMMIT_TAG}" || test -z "${DEKEN_USERNAME}" || test -z "${DEKEN_PASSWORD}" || deken upload --no-source-error ./*.dek
  artifacts:
    name: deken-package
    paths:
      - ./*.dek
      - ./*.dek.*

include:
  # additionally run some static code analysis
  - template: Security/SAST.gitlab-ci.yml
